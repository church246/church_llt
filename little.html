<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>抽彩球 — 200顆中抽三顆</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#f59e0b;--muted:#94a3b8}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",Arial;color:#e6eef8;background:linear-gradient(180deg,var(--bg),#071023);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .app{width:100%;max-width:1100px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.7);}
    header{display:flex;align-items:center;gap:16px;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .stage{display:grid;grid-template-columns:1fr 340px;gap:16px}

    /* Canvas area */
    .canvas-wrap{background:linear-gradient(180deg,#071428 0%, #081226 100%);border-radius:12px;padding:12px;min-height:360px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    canvas{width:100%;height:360px;display:block}
    .controls{display:flex;flex-direction:column;gap:10px}
    .buttons{display:flex;gap:8px}
    button{background:linear-gradient(180deg,var(--accent),#eab308);border:0;padding:10px 14px;border-radius:10px;color:#071022;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(229,158,24,0.12)}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#dbeafe;font-weight:600}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}

    /* Right column */
    .sidebar{display:flex;flex-direction:column;gap:12px}
    .result-grid{display:flex;gap:10px;justify-content:center;align-items:center}
    .ball-result{width:96px;height:96px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:800;color:#071022;background:linear-gradient(180deg,#fff,#ffd873);box-shadow:0 8px 20px rgba(0,0,0,0.45)}
    .list{max-height:220px;overflow:auto;padding:8px}
    .small{font-size:13px;color:var(--muted)}

    footer{margin-top:12px;text-align:right;color:var(--muted);font-size:13px}

    @media (max-width:900px){.stage{grid-template-columns:1fr;}.canvas-wrap{height:300px}canvas{height:300px}}
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div>
        <h1>抽彩球 — 200顆中抽三顆</h1>
        <p class="lead">按下「開始抽籤」會播放特製音樂，動畫滾動後依序抽出三顆不重複的彩球。</p>
      </div>
    </header>

    <div class="stage">
      <div>
        <div class="canvas-wrap panel">
          <canvas id="c"></canvas>
          <!-- overlay info -->
          <div style="position:absolute;left:12px;top:12px;color:var(--muted);font-size:13px">總球數: <strong id="total">200</strong></div>
          <div style="position:absolute;left:12px;bottom:12px;color:var(--muted);font-size:13px">已抽出: <span id="drawnCount">0</span></div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px">
          <div class="panel" style="flex:1">
            <div class="small">操作</div>
            <div class="buttons" style="margin-top:8px">
              <button id="startBtn">開始抽籤</button>
              <button id="resetBtn" class="secondary">重設</button>
            </div>
            <div class="small" style="margin-top:8px">速度
              <input id="speed" type="range" min="0.5" max="3" step="0.1" value="1" style="width:140px;vertical-align:middle;margin-left:8px">
            </div>
          </div>

          <div class="panel" style="width:260px">
            <div class="small">播放控制</div>
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <button id="musicToggle" class="secondary">播放音樂</button>
              <div id="status" style="flex:1;text-align:right;color:var(--muted)">靜止</div>
            </div>
            <div class="small" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <aside class="sidebar">
        <div class="panel">
          <div class="small">抽出結果</div>
          <div class="result-grid" id="results" style="margin-top:10px">
            <div class="ball-result" id="r1">—</div>
            <div class="ball-result" id="r2">—</div>
            <div class="ball-result" id="r3">—</div>
          </div>
        </div>

        <div class="panel">
          <div class="small">已抽列表（最近 20 筆）</div>
          <div class="list" id="log"></div>
        </div>

        <div class="panel">
          <div class="small">設定</div>
          <div style="margin-top:8px;font-size:13px">從 <input id="inputTotal" type="number" min="3" max="500" value="200" style="width:80px"> 顆中抽 <input id="inputPick" type="number" min="1" max="10" value="3" style="width:60px"></div>
        </div>

      </aside>
    </div>

    <footer>製作：HTML5 + Canvas • 支援觸控與滑鼠</footer>
  </div>

  <script>
    // ====== Setup canvas and balls ======
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    let DPR = window.devicePixelRatio || 1;
    function resize(){
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * DPR);
      canvas.height = Math.floor(rect.height * DPR);
      ctx.setTransform(DPR,0,0,DPR,0,0);
    }
    window.addEventListener('resize', resize);

    // Ball model
    class Ball {
      constructor(n,x,y,r,angle,vx,vy){
        this.n = n; this.x=x; this.y=y; this.r=r; this.angle=angle; this.vx=vx; this.vy=vy; this.color = this.pickColor(n);
      }
      pickColor(n){
        // simple palette based on number
        const palette = ["#f97316","#60a5fa","#34d399","#f472b6","#facc15","#a78bfa","#fb7185","#22c1c3"]
        return palette[n % palette.length];
      }
      draw(ctx){
        ctx.beginPath();
        ctx.fillStyle = this.color;
        ctx.arc(this.x,this.y,this.r,0,Math.PI*2);
        ctx.fill();
        // number
        ctx.fillStyle = '#071022';
        ctx.font = `${Math.max(12,this.r*0.8)}px system-ui`;
        ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText(this.n,this.x,this.y);
      }
    }

    // State
    let balls = [];
    let pool = [];
    let animId=null;
    let running=false;
    let picks = [];

    const totalEl = document.getElementById('total');
    const drawnCountEl = document.getElementById('drawnCount');
    const logEl = document.getElementById('log');
    const r1 = document.getElementById('r1');
    const r2 = document.getElementById('r2');
    const r3 = document.getElementById('r3');

    const inputTotal = document.getElementById('inputTotal');
    const inputPick = document.getElementById('inputPick');
    const speedEl = document.getElementById('speed');

    function resetPool(){
      const total = Math.max(3, Math.min(500, Number(inputTotal.value)||200));
      pool = Array.from({length:total}, (_,i)=>i+1);
      totalEl.textContent = total;
      drawnCountEl.textContent = 0;
    }

    function rebuildBalls(){
      balls = [];
      const w = canvas.width / DPR;
      const h = canvas.height / DPR;
      const total = pool.length;
      // show a subset visually (max 100) to keep animation smooth
      const showCount = Math.min(120,total);
      for(let i=0;i<showCount;i++){
        const n = pool[(i*13) % total];
        const r = 16 + (i%6);
        const x = Math.random()*(w-2*r)+r;
        const y = Math.random()*(h-2*r)+r;
        const ang = Math.random()*Math.PI*2;
        const vx = (Math.random()-0.5)*2;
        const vy = (Math.random()-0.5)*2;
        balls.push(new Ball(n,x,y,r,ang,vx,vy));
      }
    }

    // ====== Audio (WebAudio) ======
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    let musicOn=false;
    let bgGain = audioCtx.createGain();
    bgGain.gain.value = 0.0;
    bgGain.connect(audioCtx.destination);

    function playBackgroundLoop(){
      // simple arpeggio loop
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(220, now);
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.06, now+0.2);
      osc.connect(gain);
      gain.connect(bgGain);
      // schedule gentle pitch changes
      const root = 220;
      for(let i=0;i<8;i++){
        const t = now + i*0.25;
        osc.frequency.linearRampToValueAtTime(root * Math.pow(2, (i%4)/12), t);
      }
      osc.start(now);
      // stop later
      osc.stop(now + 8);
      // return promise-like object
      return {osc, gain, stop: ()=>{try{osc.stop();}catch(e){}}};
    }

    function chime(){
      const now = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(800, now);
      o.frequency.exponentialRampToValueAtTime(1200, now+0.12);
      g.gain.setValueAtTime(0.001, now);
      g.gain.exponentialRampToValueAtTime(0.25, now+0.02);
      g.gain.exponentialRampToValueAtTime(0.001, now+0.5);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(now); o.stop(now+0.6);
    }

    function celebrate(){
      const now = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(600, now);
      o.frequency.exponentialRampToValueAtTime(1500, now+0.3);
      g.gain.setValueAtTime(0.001, now);
      g.gain.exponentialRampToValueAtTime(0.6, now+0.05);
      g.gain.exponentialRampToValueAtTime(0.001, now+0.9);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(now); o.stop(now+1);
    }

    function boom(){
      const now = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'triangle';
      o.frequency.setValueAtTime(140, now);
      o.frequency.exponentialRampToValueAtTime(30, now+0.6);
      g.gain.setValueAtTime(0.001, now);
      g.gain.exponentialRampToValueAtTime(0.4, now+0.03);
      g.gain.exponentialRampToValueAtTime(0.001, now+0.8);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(now); o.stop(now+0.9);
    }

    // background loopkeeper
    let bgLoop=null;
    function setMusicOn(on){
      musicOn = on;
      if(on){
        // resume audio context if needed (user gesture requirement)
        audioCtx.resume();
        // ramp gain
        bgGain.gain.cancelScheduledValues(audioCtx.currentTime);
        bgGain.gain.linearRampToValueAtTime(0.08, audioCtx.currentTime+0.5);
        // create repeating short loops
        if(!bgLoop){
          bgLoop = setInterval(()=>{ playBackgroundLoop(); }, 1800);
          playBackgroundLoop();
        }
        document.getElementById('musicToggle').textContent = '停止音樂';
      } else {
        bgGain.gain.cancelScheduledValues(audioCtx.currentTime);
        bgGain.gain.linearRampToValueAtTime(0.0001, audioCtx.currentTime+0.6);
        if(bgLoop){ clearInterval(bgLoop); bgLoop=null; }
        document.getElementById('musicToggle').textContent = '播放音樂';
      }
    }

    document.getElementById('musicToggle').addEventListener('click', ()=>{
      setMusicOn(!musicOn);
    });

    // ====== Drawing and physics ======
    function step(dt){
      const w = canvas.width / DPR;
      const h = canvas.height / DPR;
      const speedMul = Number(speedEl.value) || 1;
      for(const b of balls){
        b.x += b.vx * speedMul * dt * 40;
        b.y += b.vy * speedMul * dt * 40;
        // bounce
        if(b.x - b.r < 0){ b.x = b.r; b.vx *= -1; }
        if(b.x + b.r > w){ b.x = w - b.r; b.vx *= -1; }
        if(b.y - b.r < 0){ b.y = b.r; b.vy *= -1; }
        if(b.y + b.r > h){ b.y = h - b.r; b.vy *= -1; }
      }
    }

    let lastTime = performance.now();
    function render(now){
      const dt = (now - lastTime)/1000; lastTime = now;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // background gradient
      const g = ctx.createLinearGradient(0,0,0,canvas.height);
      g.addColorStop(0,'rgba(255,255,255,0.02)'); g.addColorStop(1,'rgba(0,0,0,0.03)');
      ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width/DPR,canvas.height/DPR);

      step(dt);
      for(const b of balls){ b.draw(ctx); }
      animId = requestAnimationFrame(render);
    }

    // ====== Draw logic (pick N unique numbers with animation) ======
    async function drawN(n){
      if(running) return;
      running = true; document.getElementById('status').textContent = '抽籤中...';
      // ensure audio context resumed if user hasn't interacted
      try{ await audioCtx.resume(); }catch(e){}
      setMusicOn(true);

      const totalPick = Math.max(1, Math.min(10, Number(inputPick.value)||3));
      const total = pool.length;
      if(n > total) n = total;

      const results = [];
      for(let i=0;i<n;i++){
        // fast spin animation: increase velocities temporarily
        for(const b of balls){ b.vx = (Math.random()-0.5)*6; b.vy = (Math.random()-0.5)*6; }
        // play quick arpeggio
        playArpeggio(6, 0.04 + i*0.02);
        // short spin for a bit
        await wait(700 + i*300);
        // pick a random one from pool
        const idx = Math.floor(Math.random()*pool.length);
        const num = pool.splice(idx,1)[0];
        results.push(num);
        // show selected as big chime in center
        await highlightNumber(num, i);
        celebrate();
        document.getElementById('drawnCount').textContent = (Number(document.getElementById('drawnCount').textContent)||0)+1;
        addLog(num);
        // update small results area
        updateResultTiles(results);
      }

      // finish
      boom();
      setMusicOn(false);
      document.getElementById('status').textContent = '完成';
      running=false;
      return results;
    }

    function playArpeggio(steps, baseDelay){
      const now = audioCtx.currentTime;
      for(let i=0;i<steps;i++){
        const t = now + i*baseDelay;
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type='sawtooth'; o.frequency.setValueAtTime(220*Math.pow(1.05946, i*2), t);
        g.gain.setValueAtTime(0.0001, t); g.gain.exponentialRampToValueAtTime(0.08, t+0.02);
        g.gain.exponentialRampToValueAtTime(0.001, t+0.18);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(t); o.stop(t+0.22);
      }
    }

    function highlightNumber(num, order){
      return new Promise(resolve=>{
        const w = canvas.width / DPR; const h = canvas.height / DPR;
        const start = performance.now();
        const dur = 700;
        const origBalls = balls.slice();
        // animate a central big ball appearing
        function frame(now){
          const t = Math.min(1,(now-start)/dur);
          // draw original
          ctx.clearRect(0,0,canvas.width,canvas.height);
          const g = ctx.createLinearGradient(0,0,0,canvas.height);
          g.addColorStop(0,'rgba(255,255,255,0.02)'); g.addColorStop(1,'rgba(0,0,0,0.03)');
          ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width/DPR,canvas.height/DPR);
          for(const b of origBalls){ b.draw(ctx); }
          // big ball
          const radius = 36 + 20*(1 - Math.abs(0.5 - t));
          ctx.beginPath(); ctx.fillStyle = '#ffd873'; ctx.arc(w/2,h/2,radius,0,Math.PI*2); ctx.fill();
          ctx.fillStyle='#071022'; ctx.font = `${Math.max(18,radius*0.8)}px system-ui`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(num,w/2,h/2);
          if(t<1) requestAnimationFrame(frame); else resolve();
        }
        requestAnimationFrame(frame);
      });
    }

    function wait(ms){return new Promise(r=>setTimeout(r,ms));}

    function addLog(num){
      const el = document.createElement('div');
      el.textContent = `${new Date().toLocaleTimeString()} → ${num}`;
      logEl.prepend(el);
      // keep recent 50
      while(logEl.children.length>50) logEl.lastChild.remove();
    }

    function updateResultTiles(arr){
      const [a,b,c] = arr.concat(["—","—","—"]);
      r1.textContent = a; r2.textContent = b; r3.textContent = c;
    }

    // ====== Utilities ======
    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a}

    // ====== UI wiring ======
    document.getElementById('startBtn').addEventListener('click', async ()=>{
      // set total/pick from inputs
      resetPool();
      const pick = Math.max(1, Math.min(10, Number(inputPick.value)||3));
      rebuildBalls();
      // animate on canvas
      if(animId) cancelAnimationFrame(animId);
      resize(); lastTime = performance.now(); animId = requestAnimationFrame(render);
      const results = await drawN(pick);
      // ensure tiles updated
      updateResultTiles(results);
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      // reset everything
      resetPool(); rebuildBalls(); updateResultTiles([]);
      logEl.textContent = '';
      document.getElementById('status').textContent = '靜止';
      setMusicOn(false);
    });

    inputTotal.addEventListener('change', ()=>{ resetPool(); rebuildBalls(); });
    inputPick.addEventListener('change', ()=>{});

    // ensure initial
    resize(); resetPool(); rebuildBalls(); lastTime = performance.now(); animId = requestAnimationFrame(render);

    // resume audio on first user gesture (some browsers require gesture to start AudioContext)
    ['click','touchstart','keydown'].forEach(ev=>document.addEventListener(ev,function once(){audioCtx.resume(); document.removeEventListener(ev, once);}, {once:true}));

  </script>
</body>
</html>

