<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æŠ½çç®±å‹•ç•« â€” å‰äº”æ¬¡16é¡† + ç¬¬å…­æ¬¡20é¡† + å¤§ç + ç‰¹å¤§ç</title>
<style>
  body{margin:0;font-family:sans-serif;background:#071026;color:#e6eef8}
  .wrap{max-width:1100px;margin:18px auto;padding:18px}
  h1{margin:0 0 12px;font-size:1.25rem}
  .controls{display:flex;gap:10px;align-items:center;margin-bottom:12px}
  button{padding:10px 14px;border-radius:10px;border:0;background:#35d0ff;color:#04232f;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;color:#e6eef8;border:1px solid rgba(255,255,255,.2)}
  button:disabled{opacity:0.4;cursor:not-allowed}
  .canvas-wrap{position:relative;border-radius:12px;overflow:hidden;background:#0b1626;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  canvas{display:block;width:100%;height:600px}
  #results{margin-top:16px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px}
  .round{margin-bottom:8px}
  .round strong{margin-right:6px;color:#35d0ff}
</style>
</head>
<body>
<div class="wrap">
  <h1>æŠ½çç®±å‹•ç•«ï¼ˆ932ï½1116ï¼‰</h1>
  <div class="controls">
    <button id="drawBtn">é–‹å§‹æŠ½ç</button>
    <button id="grandBtn" class="ghost" disabled>æŠ½å¤§ç</button>
    <button id="superBtn" class="ghost" disabled>æŠ½ç‰¹å¤§ç</button>
    <button id="resetBtn" class="ghost">å…¨éƒ¨é‡ç½®</button>
  </div>

  <div class="canvas-wrap" id="box">
    <canvas id="c"></canvas>
  </div>

  <div id="results">
    <h3>æŠ½ççµæœ</h3>
    <div id="rounds"></div>
  </div>
</div>

<!-- éŸ³æ•ˆ -->
<audio id="drawSound" src="images/prosounds.mp3" preload="auto"></audio>
<audio id="grandSound" src="images/prosounds.mp3" preload="auto"></audio>

<script>
const MIN=932,MAX=1116;
const BATCH16=16,BATCH20=20;
const canvas=document.getElementById('c'),ctx=canvas.getContext('2d',{alpha:false});
let W=1200,H=600;
function resize(){
  const dpr=window.devicePixelRatio||1;
  W=canvas.clientWidth=canvas.parentElement.clientWidth;
  H=600;
  canvas.width=W*dpr;
  canvas.height=H*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize',resize);
resize();

const COLORS=['#f97316','#fb7185','#60a5fa','#34d399','#f43f5e','#a78bfa','#f59e0b','#06b6d4'];

class Ball{
  constructor(num,x,y,vx,vy,r=20){
    this.num=num;
    this.x=x;
    this.y=y;
    this.vx=vx;
    this.vy=vy;
    this.r=r;
    this.color=COLORS[Math.floor(Math.random()*COLORS.length)];
    this.isPicked=false;
    this.grandEffect=false;
    this.effectTime=0;
  }
  draw(){
    ctx.beginPath();
    let radius=this.r;
    let alpha=1;
    let color=this.color;
    if(this.grandEffect){
      alpha=0.5+0.5*Math.sin(this.effectTime*10);
      radius=this.r+10*Math.sin(this.effectTime*10);
      color=`hsl(${this.effectTime*200%360},100%,50%)`;
    }
    ctx.fillStyle=color;
    ctx.globalAlpha=alpha;
    ctx.arc(this.x,this.y,radius,0,Math.PI*2);
    ctx.fill();
    ctx.globalAlpha=1;
    ctx.fillStyle='#021017';
    ctx.font=`${radius*0.6}px sans-serif`;
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText(this.num,this.x,this.y);
  }
  step(dt){
    if(this.isPicked && !this.grandEffect) return;
    this.x+=this.vx*dt;
    this.y+=this.vy*dt;
    if(this.x<this.r||this.x>W-this.r) this.vx*=-1;
    if(this.y<this.r||this.y>H-this.r) this.vy*=-1;
    if(this.grandEffect) this.effectTime+=dt;
  }
}

// å½©å¸¶é¡
class Confetti{
  constructor(){
    this.x=Math.random()*W;
    this.y=-20;
    this.w=6+Math.random()*4;
    this.h=8+Math.random()*6;
    this.color=COLORS[Math.floor(Math.random()*COLORS.length)];
    this.speed=50+Math.random()*100;
    this.angle=Math.random()*Math.PI*2;
    this.spin=(Math.random()-0.5)*0.2;
  }
  step(dt){
    this.y+=this.speed*dt;
    this.angle+=this.spin;
    if(this.y>H+20) this.dead=true;
  }
  draw(){
    ctx.save();
    ctx.translate(this.x,this.y);
    ctx.rotate(this.angle);
    ctx.fillStyle=this.color;
    ctx.fillRect(-this.w/2,-this.h/2,this.w,this.h);
    ctx.restore();
  }
}

let allNumbers=[];
for(let i=MIN;i<=MAX;i++) allNumbers.push(i);
let balls=[],confetti=[];
function initBalls(){
  balls=[];
  for(const num of allNumbers){
    const r=18+Math.random()*6;
    const x=r+Math.random()*(W-2*r);
    const y=r+Math.random()*(H-2*r);
    const sp=40+Math.random()*60;
    const a=Math.random()*Math.PI*2;
    balls.push(new Ball(num,x,y,Math.cos(a)*sp,Math.sin(a)*sp,r));
  }
  confetti=[];
}

function update(dt){
  for(const b of balls)b.step(dt);
  for(const c of confetti)c.step(dt);
  confetti=confetti.filter(c=>!c.dead);
}
function render(){
  ctx.fillStyle='#071226';
  ctx.fillRect(0,0,W,H);
  for(const b of balls)b.draw();
  for(const c of confetti)c.draw();
}

let last=performance.now();
function loop(t){
  const dt=(t-last)/1000;
  last=t;
  update(dt);
  render();
  requestAnimationFrame(loop);
}
initBalls();
requestAnimationFrame(loop);

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

const rounds=document.getElementById('rounds');
let round=0;
const grandBtn=document.getElementById('grandBtn');
const superBtn=document.getElementById('superBtn');
let grandDrawn=false,superDrawn=false;

// æŠ½çï¼ˆå‰5æ¬¡æŠ½16é¡†ï¼Œç¬¬6æ¬¡æŠ½20é¡†ï¼‰
async function draw(){
  const pool=balls.filter(b=>!b.isPicked);
  if(pool.length===0){alert('æ²’æœ‰çƒå¯æŠ½äº†');return;}

  const drawSound=document.getElementById('drawSound');
  drawSound.currentTime=0;drawSound.play();

  shuffle(pool);
  const take=(round<5)?Math.min(BATCH16,pool.length):Math.min(BATCH20,pool.length);
  const selected=pool.slice(0,take);
  for(const b of selected)b.isPicked=true;

  const nums=selected.map(b=>b.num);
  const currentRound=round+1;

  setTimeout(()=>{
    round=currentRound;
    let resultHtml=`<strong>ç¬¬ ${round} è¼ªï¼š</strong><br>`;
    nums.forEach((num,idx)=>{
      const prize=(round<=5)?(round-1)*BATCH16+(idx+1):(5*BATCH16+idx+1);
      resultHtml+=`<span style="color:#facc11;font-weight:700">ğŸ† ç¬¬${prize}ç ${num}<br></span>`;
    });
    const div=document.createElement('div');
    div.className='round';
    div.innerHTML=resultHtml;
    rounds.prepend(div);
    if(round>=6 && !grandDrawn){
      grandBtn.disabled=false;
    }
  },10000);
}

// æŠ½å¤§ç
function drawGrandPrize(){
  if(grandDrawn){alert('å¤§çå·²æŠ½é');return;}
  const pool=balls.filter(b=>!b.isPicked);
  if(pool.length===0){alert('æ²’æœ‰å‰©é¤˜è™Ÿç¢¼å¯æŠ½ï¼');return;}
  shuffle(pool);
  const lucky=pool[0];
  lucky.grandEffect=true;
  lucky.isPicked=true;
  grandDrawn=true;
  grandBtn.disabled=true;

  const grandSound=document.getElementById('grandSound');
  grandSound.currentTime=0;grandSound.play();

  let elapsed=0,duration=3;
  const anim=()=>{
    elapsed+=0.016;
    if(elapsed>=duration){
      balls=balls.filter(b=>b!==lucky);
      const div=document.createElement('div');
      div.className='round';
      div.innerHTML=`<strong style="color:#facc15;font-size:1.2em">ğŸ‰ å¤§çè™Ÿç¢¼ï¼š</strong> <span style="color:#f87171;font-weight:700">${lucky.num}</span>`;
      rounds.prepend(div);
      superBtn.disabled=false; // å¤§çæŠ½å®Œæ‰èƒ½æŠ½ç‰¹å¤§ç
      return;
    }
    requestAnimationFrame(anim);
  }
  anim();
}

// æŠ½ç‰¹å¤§çï¼ˆå«å½©å¸¶æ•ˆæœï¼‰
function drawSuperPrize(){
  if(superDrawn){alert('ç‰¹å¤§çå·²æŠ½é');return;}
  const pool=balls.filter(b=>!b.isPicked);
  if(pool.length===0){alert('æ²’æœ‰å‰©é¤˜è™Ÿç¢¼å¯æŠ½ï¼');return;}
  shuffle(pool);
  const lucky=pool[0];
  lucky.grandEffect=true;
  lucky.isPicked=true;
  superDrawn=true;
  superBtn.disabled=true;

  const grandSound=document.getElementById('grandSound');
  grandSound.currentTime=0;grandSound.play();

  // å½©å¸¶ç”Ÿæˆ
  for(let i=0;i<200;i++){
    setTimeout(()=>{confetti.push(new Confetti());},i*20);
  }

  let elapsed=0,duration=5;
  const anim=()=>{
    elapsed+=0.016;
    if(elapsed>=duration){
      balls=balls.filter(b=>b!==lucky);
      const div=document.createElement('div');
      div.className='round';
      div.innerHTML=`<strong style="color:#ff0;font-size:1.4em">ğŸŒŸ ç‰¹å¤§çè™Ÿç¢¼ï¼š</strong> <span style="color:#0ff;font-weight:900">${lucky.num}</span>`;
      rounds.prepend(div);
      return;
    }
    requestAnimationFrame(anim);
  }
  anim();
}

document.getElementById('drawBtn').onclick=draw;
grandBtn.onclick=drawGrandPrize;
superBtn.onclick=drawSuperPrize;

// é‡ç½®
document.getElementById('resetBtn').onclick=()=>{
  if(confirm('ç¢ºå®šé‡ç½®ï¼Ÿ')){
    rounds.innerHTML='';
    round=0;
    grandDrawn=false;
    superDrawn=false;
    grandBtn.disabled=true;
    superBtn.disabled=true;
    initBalls();
  }
};
</script>
</body>
</html>
